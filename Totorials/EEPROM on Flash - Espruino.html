<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<!-- saved from url=(0036)https://www.espruino.com/FlashEEPROM -->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta name="viewport" content="width=650, initial-scale=1">
<meta name="Description" content="JavaScript on a Microcontroller">
<meta name="Keywords" content="Espruino, Pico, Espruino Pico, Espurino, Espruino WiFi, Puck.js, Puckjs, Puck-js, JavaScript, JS, ARM, Arduino, MCU, STM32, NRF, NRF52, Microcontroller, Embedded, Module, Flash, EEPROM, storage, non-volatile, memory, rom, storage">

<meta name="Distribution" content="Global">
<meta name="Robots" content="index,follow">
<title>EEPROM on Flash - Espruino</title>

<script type="text/javascript" async="" src="./EEPROM on Flash - Espruino_files/ga.js.download"></script><script type="text/javascript" src="./EEPROM on Flash - Espruino_files/jquery-1.11.1.min.js.download"></script>
<link href="./EEPROM on Flash - Espruino_files/bootstrap.min.css" rel="stylesheet">
<!--[if lt IE 9]>
  <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
  <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
<![endif]-->
<link href="./EEPROM on Flash - Espruino_files/carousel.css" rel="stylesheet">
<link rel="stylesheet" href="./EEPROM on Flash - Espruino_files/sitewide.css" type="text/css">

<link rel="stylesheet" href="./EEPROM on Flash - Espruino_files/prettify.css" type="text/css">
<script src="./EEPROM on Flash - Espruino_files/prettify.js.download"></script>
<script type="text/javascript" src="./EEPROM on Flash - Espruino_files/search.js.download"></script>
<script type="text/javascript" src="./EEPROM on Flash - Espruino_files/codeblock.js.download"></script>
<script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "WebSite",
  "url": "https://www.espruino.com/",
  "potentialAction": {
    "@type": "SearchAction",
    "target": "http://www.espruino.com/Search?kw={search_term}",
    "query-input": "required name=search_term"
  }
}
</script>
<script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-35839191-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>
</head>

<body>
  <div class="navbar-wrapper" id="header"> <!-- id=header for search -->
    <div class="navbar navbar-inverse" role="navigation">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="https://www.espruino.com/">Espruino</a>
        </div>
        <div class="navbar-collapse collapse">
          <ul class="nav navbar-nav">
            <li class="dropdown">
              <a href="https://www.espruino.com/FlashEEPROM#" class="dropdown-toggle" data-toggle="dropdown">Get Espruino<b class="caret"></b></a>
              <ul class="dropdown-menu">
                <li><a href="https://www.espruino.com/Order">Buy Espruino</a></li>
                <li><a href="https://www.espruino.com/Download">Download firmware</a></li>
              </ul>
            </li>
            <li><a href="https://www.espruino.com/Donate">Donate</a></li>
            <li class="dropdown">
              <a href="https://www.espruino.com/FlashEEPROM#" class="dropdown-toggle" data-toggle="dropdown">Documentation <b class="caret"></b></a>
              <ul class="dropdown-menu">
                <li><a href="https://www.espruino.com/Quick+Start">Quick Start</a></li>
                <li class="divider"></li>
                <li><a href="https://www.espruino.com/Reference#software">API Reference</a></li>
                <li><a href="https://www.espruino.com/Tutorials">Tutorials &amp; Examples</a></li>
                <li><a href="https://www.espruino.com/Modules">Modules</a></li>
                <li class="divider"></li>
                <li><a href="https://www.espruino.com/EspruinoBoard">Original Espruino</a></li>
                <li><a href="https://www.espruino.com/Pico">Espruino Pico</a></li>
                <li><a href="https://www.espruino.com/WiFi">Espruino WiFi</a></li>
                <li><a href="https://www.espruino.com/Puck.js">Puck.js</a></li>
              </ul>
            </li>
            <li class="dropdown">
              <a href="https://www.espruino.com/FlashEEPROM#" class="dropdown-toggle" data-toggle="dropdown">Support <b class="caret"></b></a>
              <ul class="dropdown-menu">
                <li><a href="http://forum.espruino.com/">Forums</a></li>
                <li class="divider"></li>
                <li><a href="https://www.espruino.com/FAQ">FAQ</a></li>
                <li><a href="https://www.espruino.com/Troubleshooting">Troubleshooting</a></li>
                <li class="divider"></li>
                <li><a href="https://www.espruino.com/Contact+Us">Contact Us</a></li>
                <li><a href="https://www.espruino.com/Press">Press Info</a></li>
              </ul>
            </li>
          </ul>
          <form class="navbar-form navbar-right">
            <span class="hidden-sm hidden-xs">
              <a href="http://www.facebook.com/sharer.php?u=http://www.espruino.com&amp;t=Espruino+JavaScript+for+Microcontrollers" target="_blank" title="Share on Facebook"><img height="20" src="./EEPROM on Flash - Espruino_files/socialtiny_facebook.png" width="20" class="socialtiny"></a>
              <a href="https://plus.google.com/share?url=http://www.espruino.com" target="_blank" title="Share on Google+"><img height="20" src="./EEPROM on Flash - Espruino_files/socialtiny_google.png" width="20" class="socialtiny"></a>
              <a href="http://twitter.com/Espruino" target="_blank" title="Follow us on Twitter"><img height="20" src="./EEPROM on Flash - Espruino_files/socialtiny_twitter.png" width="24" class="socialtiny"></a>
              <a href="http://youtube.com/subscription_center?add_user=espruino" target="_blank" title="YouTube"><img alt="YouTube" src="./EEPROM on Flash - Espruino_files/youtube_tinyw.png"></a>
            </span>

            <input type="text" class="form-control searchbox" name="searchbox" placeholder="Search..." autocomplete="off" size="15">
          </form>
        </div>
      </div><!-- /.container -->
    </div><!-- /.navbar -->
  </div><!-- /.navbar-wrapper -->

  <!-- Wrap the rest of the page in another container to center all the content. -->
  <div id="mainscroller">
    <div class="container">
      <div id="maincontent"><div style="min-height:700px;"><h1 id="eeprom-on-flash">EEPROM on Flash</h1>
<!---
* KEYWORDS: Module,Flash,EEPROM,storage,non-volatile,memory,rom,storage
--->
<p>STM32-based chips don't have nonvolatile EEPROM memory (which can be changed one byte at a
time). Instead, they have Flash memory in which 32 bit words can be written one at a time,
<em>but not overwritten</em>.</p>
<p>To overwrite some data, you need to erase an entire flash page, which could be as much as 128kB long!</p>
<p>To work around this, We've provided a 'Fake EEPROM' module called <a href="https://www.espruino.com/modules/FlashEEPROM.js">FlashEEPROM</a> (<a href="https://www.espruino.com/Modules">About Modules</a>).</p>
<p>This stores a 'journal' of all written data. When you write something new to it, that data
goes on the end of the journal (if it's too long, everything is read into RAM, the page is
erased, and only the latest values are written back).</p>
<p>You use it as follows:</p>
<pre><code class="prettyprint prettyprinted" style=""><span class="com">/* No arguments mean use the default, which will work on the Original Espruino or Espruino Pico
 You can supply extra arguments to choose which flash page you'll use, and even whether you
 use external flash memory - but be careful when doing this. You can accidentally overwrite
 Espruino itself! */</span><span class="pln">
</span><span class="kwd">var</span><span class="pln"> f </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">new</span><span class="pln"> </span><span class="pun">(</span><span class="kwd">require</span><span class="pun">(</span><span class="str">"FlashEEPROM"</span><span class="pun">))();</span><span class="pln">

f</span><span class="pun">.</span><span class="pln">write</span><span class="pun">(</span><span class="lit">0</span><span class="pun">,</span><span class="pln"> </span><span class="str">"Hello"</span><span class="pun">);</span><span class="pln">
f</span><span class="pun">.</span><span class="pln">write</span><span class="pun">(</span><span class="lit">1</span><span class="pun">,</span><span class="pln"> </span><span class="str">"World"</span><span class="pun">);</span><span class="pln">
</span><span class="com">//.. you can write to any address between 0 and 255, with any data up to 65536 chars long</span><span class="pln">

f</span><span class="pun">.</span><span class="pln">read</span><span class="pun">(</span><span class="lit">0</span><span class="pun">)</span><span class="pln">
</span><span class="com">// returns new Uint8Array([72, 101, 108, 108, 111])</span><span class="pln">

E</span><span class="pun">.</span><span class="pln">toString</span><span class="pun">(</span><span class="pln">f</span><span class="pun">.</span><span class="pln">read</span><span class="pun">(</span><span class="lit">1</span><span class="pun">))</span><span class="pln">
</span><span class="com">// returns "World"</span><span class="pln">

f</span><span class="pun">.</span><span class="pln">readMem</span><span class="pun">(</span><span class="lit">0</span><span class="pun">)</span><span class="pln">
</span><span class="com">// returns "Hello" - this is a special string that is accessed directly from ROM</span><span class="pln">
</span><span class="com">// (and is not loaded into RAM first)</span><span class="pln">

f</span><span class="pun">.</span><span class="pln">readAll</span><span class="pun">();</span><span class="pln">
</span><span class="com">// returns [</span><span class="pln">
</span><span class="com">//  new Uint8Array([72, 101, 108, 108, 111]),</span><span class="pln">
</span><span class="com">//  new Uint8Array([87, 111, 114, 108, 100])</span><span class="pln">
</span><span class="com">// ]</span><span class="pln">

f</span><span class="pun">.</span><span class="pln">write</span><span class="pun">(</span><span class="lit">1</span><span class="pun">,</span><span class="pln"> </span><span class="str">"Espruino"</span><span class="pun">);</span><span class="pln">
</span><span class="com">// has now overwritten 'World'</span><span class="pln">

E</span><span class="pun">.</span><span class="pln">toString</span><span class="pun">(</span><span class="pln">f</span><span class="pun">.</span><span class="pln">read</span><span class="pun">(</span><span class="lit">1</span><span class="pun">))</span><span class="pln">
</span><span class="com">// returns "Espruino"</span><span class="pln">

</span><span class="com">/* You can tidy up the journal if you want, removing any values that were
overwritten by subsequent writes. It can take around a second though */</span><span class="pln">
f</span><span class="pun">.</span><span class="pln">cleanup</span><span class="pun">();</span><span class="pln">

</span><span class="com">// Or clear absolutely everything out of memory</span><span class="pln">
f</span><span class="pun">.</span><span class="pln">erase</span><span class="pun">();</span><a href="http://www.espruino.com/webide?code=%2F*%20No%20arguments%20mean%20use%20the%20default%2C%20which%20will%20work%20on%20the%20Original%20Espruino%20or%20Espruino%20Pico%0A%20You%20can%20supply%20extra%20arguments%20to%20choose%20which%20flash%20page%20you%27ll%20use%2C%20and%20even%20whether%20you%0A%20use%20external%20flash%20memory%20-%20but%20be%20careful%20when%20doing%20this.%20You%20can%20accidentally%20overwrite%0A%20Espruino%20itself!%20*%2F%0Avar%20f%20%3D%20new%20(require(%22FlashEEPROM%22))()%3B%0A%0Af.write(0%2C%20%22Hello%22)%3B%0Af.write(1%2C%20%22World%22)%3B%0A%2F%2F..%20you%20can%20write%20to%20any%20address%20between%200%20and%20255%2C%20with%20any%20data%20up%20to%2065536%20chars%20long%0A%0Af.read(0)%0A%2F%2F%20returns%20new%20Uint8Array(%5B72%2C%20101%2C%20108%2C%20108%2C%20111%5D)%0A%0AE.toString(f.read(1))%0A%2F%2F%20returns%20%22World%22%0A%0Af.readMem(0)%0A%2F%2F%20returns%20%22Hello%22%20-%20this%20is%20a%20special%20string%20that%20is%20accessed%20directly%20from%20ROM%0A%2F%2F%20(and%20is%20not%20loaded%20into%20RAM%20first)%0A%0Af.readAll()%3B%0A%2F%2F%20returns%20%5B%0A%2F%2F%20%20new%20Uint8Array(%5B72%2C%20101%2C%20108%2C%20108%2C%20111%5D)%2C%0A%2F%2F%20%20new%20Uint8Array(%5B87%2C%20111%2C%20114%2C%20108%2C%20100%5D)%0A%2F%2F%20%5D%0A%0Af.write(1%2C%20%22Espruino%22)%3B%0A%2F%2F%20has%20now%20overwritten%20%27World%27%0A%0AE.toString(f.read(1))%0A%2F%2F%20returns%20%22Espruino%22%0A%0A%2F*%20You%20can%20tidy%20up%20the%20journal%20if%20you%20want%2C%20removing%20any%20values%20that%20were%0Aoverwritten%20by%20subsequent%20writes.%20It%20can%20take%20around%20a%20second%20though%20*%2F%0Af.cleanup()%3B%0A%0A%2F%2F%20Or%20clear%20absolutely%20everything%20out%20of%20memory%0Af.erase()%3B%0A" class="codelink" title="Send to Web IDE"></a></code></pre><h2 id="speed">Speed</h2>
<p>This module can be quite slow as it will scan all of the flash page for data. The more times
you change the data, the bigger the journal gets, and the slower both reads and writes will get.</p>
<p>You can explicitly call <code class="prettyprint prettyprinted" style=""><span class="pln">f</span><span class="pun">.</span><span class="pln">cleanup</span><span class="pun">()</span></code> which will re-write the data to just what is needed, but
you should be aware that flash memory has a fixed number of write cycles (see the IC's datasheet)
so you should try and do this as rarely as possible.</p>
<p>Another option is to limit the amount of Flash memory that can be used. This is a good idea if
you're using something like the Espruino Pico that will default to using the full 128kB page!</p>
<pre><code class="prettyprint prettyprinted" style=""><span class="com">// Use only 1024 bytes</span><span class="pln">
f</span><span class="pun">.</span><span class="pln">endAddr </span><span class="pun">=</span><span class="pln"> f</span><span class="pun">.</span><span class="pln">addr</span><span class="pun">+</span><span class="lit">1024</span><span class="pun">;</span><a href="http://www.espruino.com/webide?code=%2F%2F%20Use%20only%201024%20bytes%0Af.endAddr%20%3D%20f.addr%2B1024%3B%0A" class="codelink" title="Send to Web IDE"></a></code></pre><h2 id="reference">Reference</h2>
<pre><code class="lang-Java prettyprint prettyprinted" style=""><span class="com">/* Internal function - return an object containing:
    * addr: the address in memory of the key (must be between 0 and 255), or -1 if it doesn't exist 
    * end: the address of the next free entry in memory
*/</span><span class="pln">
</span><span class="typ">FlashEEPROM</span><span class="pun">.</span><span class="pln">prototype</span><span class="pun">.</span><span class="pln">getAddr </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">function</span><span class="pln"> </span><span class="pun">(</span><span class="pln">addr</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"> </span><span class="pun">...</span><span class="pln"> </span><span class="pun">}</span><span class="pln">

</span><span class="com">/* Read the current value of a key (key must be between 0 and 255).
 This will return a Uint8Array. It can be converted to a string
 with E.toString()
*/</span><span class="pln">
</span><span class="typ">FlashEEPROM</span><span class="pun">.</span><span class="pln">prototype</span><span class="pun">.</span><span class="pln">read </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">function</span><span class="pln"> </span><span class="pun">(</span><span class="pln">addr</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"> </span><span class="pun">...</span><span class="pln"> </span><span class="pun">}</span><span class="pln">

</span><span class="com">/* Read the current value of a key (key must be between 0 and 255).
 This will return a 'Memory Area' string, which directly references the
 data in flash memory rather than loading it into RAM first. This is 
 useful when you've written a lot of data and you're trying to save
 RAM.
*/</span><span class="pln">
</span><span class="typ">FlashEEPROM</span><span class="pun">.</span><span class="pln">prototype</span><span class="pun">.</span><span class="pln">readMem </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">function</span><span class="pln"> </span><span class="pun">(</span><span class="pln">addr</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"> </span><span class="pun">...</span><span class="pln"> </span><span class="pun">}</span><span class="pln">

</span><span class="com">// return the current values of all keys in an array</span><span class="pln">
</span><span class="typ">FlashEEPROM</span><span class="pun">.</span><span class="pln">prototype</span><span class="pun">.</span><span class="pln">readAll </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">function</span><span class="pln"> </span><span class="pun">()</span><span class="pln"> </span><span class="pun">{</span><span class="pln"> </span><span class="pun">...</span><span class="pln"> </span><span class="pun">}</span><span class="pln">

</span><span class="com">// Internal function to write a data block</span><span class="pln">
</span><span class="typ">FlashEEPROM</span><span class="pun">.</span><span class="pln">prototype</span><span class="pun">.</span><span class="pln">_write </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">function</span><span class="pln"> </span><span class="pun">(</span><span class="pln">n</span><span class="pun">,</span><span class="pln"> addr</span><span class="pun">,</span><span class="pln"> data</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"> </span><span class="pun">...</span><span class="pln"> </span><span class="pun">}</span><span class="pln">

</span><span class="com">/* Write a new value.  Addr must be between 0 and 255, data 
 can be a string or uint8array but cannot be longer than 255 bytes
*/</span><span class="pln">
</span><span class="typ">FlashEEPROM</span><span class="pun">.</span><span class="pln">prototype</span><span class="pun">.</span><span class="pln">write </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">function</span><span class="pln"> </span><span class="pun">(</span><span class="pln">addr</span><span class="pun">,</span><span class="pln"> data</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"> </span><span class="pun">...</span><span class="pln"> </span><span class="pun">}</span><span class="pln">

</span><span class="com">// Read all data, erase the page, and write it back (removing duplicates)</span><span class="pln">
</span><span class="typ">FlashEEPROM</span><span class="pun">.</span><span class="pln">prototype</span><span class="pun">.</span><span class="pln">cleanup </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">function</span><span class="pln"> </span><span class="pun">()</span><span class="pln"> </span><span class="pun">{</span><span class="pln"> </span><span class="pun">...</span><span class="pln"> </span><span class="pun">}</span><span class="pln">

</span><span class="com">// Erase everything</span><span class="pln">
</span><span class="typ">FlashEEPROM</span><span class="pun">.</span><span class="pln">prototype</span><span class="pun">.</span><span class="pln">erase </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">function</span><span class="pln"> </span><span class="pun">()</span><span class="pln"> </span><span class="pun">{</span><span class="pln"> </span><span class="pun">...</span><span class="pln"> </span><span class="pun">}</span><span class="pln">

</span><span class="com">/* Create a new Flash EEPROM.

 `addr` - addr to start at (if left off, this will be the address 
   after the last page of Flash. In the Original Espruino and 
   Espruino Pico, this is an flash page that isn't supposed to
   be in the chip - but which is on every one we have tested.

 `flash` - the flash object to use (it will use the internal 
   flash if this undefined). If an object implements read, write,
   erasePage and getPage then it can be used
*/</span><span class="pln">
</span><span class="kwd">function</span><span class="pln"> </span><span class="pun">(</span><span class="pln">addr</span><span class="pun">,</span><span class="pln"> flash</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"> </span><span class="pun">...</span><span class="pln"> </span><span class="pun">}</span></code></pre>
<h2 id="using">Using</h2>
<p>No tutorials use this yet.</p>
</div><p style="text-align:right;font-size:75%;">This page is auto-generated from <a href="https://github.com/espruino/EspruinoDocs/blob/master/modules/FlashEEPROM.md">GitHub</a>. If you see any mistakes or have suggestions, please <a href="https://github.com/espruino/EspruinoDocs/issues/new?title=modules/FlashEEPROM.md">let us know</a>.</p></div>
      <div class="row">
        <div id="sidebar" class="col-md-3 hidden-sm hidden-xs"></div>
        <div id="maincolumn" class="col-md-9"></div>
      </div>

      <hr>
      <!-- FOOTER -->
      <footer>
        <p>
  			© 2017 <strong>Pur3 Ltd</strong>
  			(<a href="https://www.espruino.com/FlashEEPROM?print">Printable Version</a>)
        <a href="https://www.espruino.com/edit.php?page=FlashEEPROM" class="edit" style="float:right;">π</a>
  			</p>
      </footer>

    </div><!-- /.container -->
  </div><!-- /#mainscroller -->
  <!-- Placed at the end of the document so the pages load faster -->
  <script>
    // if there's a contents element, add it to the page
    var contents = document.getElementById("contents");
    if (contents) {
      document.getElementById("sidebar").appendChild(contents);
      document.getElementById("maincolumn").appendChild(document.getElementById("maincontent"));
    }
  </script>
  <script src="./EEPROM on Flash - Espruino_files/jquery-1.11.1.min.js.download"></script>
  <script src="./EEPROM on Flash - Espruino_files/bootstrap.min.js.download"></script>
  <script type="text/javascript" src="./EEPROM on Flash - Espruino_files/search.js.download"></script>


</body></html>